flowchart TD
    subgraph ENTRADA["ğŸŒ ENTRADA"]
        A[("ğŸ”— GET /agendar-v3/:slug<br/><i>Webhook</i>")]
    end

    subgraph VALIDACION["ğŸ›¡ï¸ VALIDACIÃ“N"]
        B["âš™ï¸ Paranoid Guard<br/><i>Code</i>"]
        C{"âœ… Validation OK?<br/><i>Switch</i>"}
    end

    subgraph CONSULTAS_DB["ğŸ—„ï¸ CONSULTAS PARALELAS"]
        D1["ğŸ” DB: Find Provider<br/><i>Postgres</i>"]
        D2["âš™ï¸ DB: Get Bot Config<br/><i>Postgres</i>"]
        E["ğŸ”€ Wait Both Inputs<br/><i>Merge</i>"]
        F["ğŸ“Š Process DB Results<br/><i>Code</i>"]
    end

    subgraph CHECK_DB["ğŸ”Œ VERIFICACIÃ“N DB"]
        G{"ğŸ—„ï¸ DB OK?<br/><i>Switch</i>"}
    end

    subgraph CHECK_PROVIDER["ğŸ‘¤ VERIFICACIÃ“N PROVIDER"]
        H{"ğŸ‘¤ Provider Found?<br/><i>Switch</i>"}
    end

    subgraph EXITO["âœ… Ã‰XITO"]
        I1["ğŸ“ Log: Success<br/><i>Postgres</i>"]
        I2["ğŸ”„ Redirect Telegram<br/><i>HTTP 302</i>"]
    end

    subgraph NOT_FOUND["âŒ NO ENCONTRADO"]
        J1["ğŸ“ Log: Not Found<br/><i>Postgres</i>"]
        J2["ğŸš« 404 Not Found<br/><i>HTTP 404</i>"]
    end

    subgraph ERROR_VALIDACION["âš ï¸ ERROR VALIDACIÃ“N"]
        K1["ğŸ“‹ Prepare Validation Error<br/><i>Code</i>"]
        K2["ğŸ“ Log: Validation Error<br/><i>Postgres</i>"]
        K3["ğŸ“ Call BB_00<br/><i>Execute Workflow</i>"]
        K4["ğŸš« 400 Bad Request<br/><i>HTTP 400</i>"]
    end

    subgraph ERROR_DB["ğŸ’¥ ERROR DATABASE"]
        L1["ğŸ“‹ Prepare DB Error<br/><i>Code</i>"]
        L2["ğŸ“ Log: DB Error<br/><i>Postgres</i>"]
        L3["ğŸ”” Notify Admin BB_00<br/><i>Execute Workflow</i>"]
        L4["ğŸš« 503 Service Unavailable<br/><i>HTTP 503</i>"]
    end

    %% Conexiones principales
    A --> B
    B --> C
    
    %% ValidaciÃ³n OK - Flujo paralelo
    C -->|"âœ“ error=false"| D1
    C -->|"âœ“ error=false"| D2
    
    %% ValidaciÃ³n fallida
    C -->|"âœ— fallback"| K1
    
    %% Merge de consultas
    D1 --> E
    D2 --> E
    E --> F
    F --> G
    
    %% Check DB
    G -->|"âœ“ db_error=false"| H
    G -->|"âœ— fallback"| L1
    
    %% Check Provider
    H -->|"âœ“ found=true"| I1
    H -->|"âœ— fallback"| J1
    
    %% Flujos finales
    I1 --> I2
    J1 --> J2
    
    %% Error validaciÃ³n
    K1 --> K2
    K2 --> K3
    K3 --> K4
    
    %% Error DB
    L1 --> L2
    L2 --> L3
    L3 --> L4

    %% Estilos
    classDef webhook fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef code fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef switch fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef postgres fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef merge fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef success fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    classDef error fill:#ffcdd2,stroke:#c62828,stroke-width:3px
    classDef warning fill:#fff9c4,stroke:#f9a825,stroke-width:3px

    class A webhook
    class B,F,K1,L1 code
    class C,G,H switch
    class D1,D2,I1,J1,K2,L2 postgres
    class E merge
    class I2 success
    class J2,K4 warning
    class L4 error